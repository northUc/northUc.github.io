<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>docker | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.9854472c.css" as="style"><link rel="preload" href="/assets/js/app.188d2b4b.js" as="script"><link rel="preload" href="/assets/js/45.3b76131f.js" as="script"><link rel="prefetch" href="/assets/js/10.78f49902.js"><link rel="prefetch" href="/assets/js/11.54a6664f.js"><link rel="prefetch" href="/assets/js/12.fb7436a2.js"><link rel="prefetch" href="/assets/js/13.88a9f8ba.js"><link rel="prefetch" href="/assets/js/14.c854726e.js"><link rel="prefetch" href="/assets/js/15.41da25a8.js"><link rel="prefetch" href="/assets/js/16.93613165.js"><link rel="prefetch" href="/assets/js/17.77c8c8f4.js"><link rel="prefetch" href="/assets/js/18.fb67ca7b.js"><link rel="prefetch" href="/assets/js/19.b16febc7.js"><link rel="prefetch" href="/assets/js/2.d8f505d4.js"><link rel="prefetch" href="/assets/js/20.865d4ba1.js"><link rel="prefetch" href="/assets/js/21.8fbca06b.js"><link rel="prefetch" href="/assets/js/22.1f7d1a22.js"><link rel="prefetch" href="/assets/js/23.a41ee23e.js"><link rel="prefetch" href="/assets/js/24.1b9dbaa8.js"><link rel="prefetch" href="/assets/js/25.96a87374.js"><link rel="prefetch" href="/assets/js/26.d7f87ea9.js"><link rel="prefetch" href="/assets/js/27.938cea29.js"><link rel="prefetch" href="/assets/js/28.22d5a464.js"><link rel="prefetch" href="/assets/js/29.f1258146.js"><link rel="prefetch" href="/assets/js/3.8796f9d7.js"><link rel="prefetch" href="/assets/js/30.555391dd.js"><link rel="prefetch" href="/assets/js/31.1c089743.js"><link rel="prefetch" href="/assets/js/32.f1710f84.js"><link rel="prefetch" href="/assets/js/33.3a44c355.js"><link rel="prefetch" href="/assets/js/34.89fc76ca.js"><link rel="prefetch" href="/assets/js/35.ae5ec0f1.js"><link rel="prefetch" href="/assets/js/36.14636755.js"><link rel="prefetch" href="/assets/js/37.85c35c6f.js"><link rel="prefetch" href="/assets/js/38.4b97d4eb.js"><link rel="prefetch" href="/assets/js/39.c4574241.js"><link rel="prefetch" href="/assets/js/4.c59777f9.js"><link rel="prefetch" href="/assets/js/40.2ae0ff3f.js"><link rel="prefetch" href="/assets/js/41.f55ba23e.js"><link rel="prefetch" href="/assets/js/42.5f71b867.js"><link rel="prefetch" href="/assets/js/43.d4963081.js"><link rel="prefetch" href="/assets/js/44.e4b90d65.js"><link rel="prefetch" href="/assets/js/46.cb50381c.js"><link rel="prefetch" href="/assets/js/47.5b0c84f7.js"><link rel="prefetch" href="/assets/js/48.9c8ec2da.js"><link rel="prefetch" href="/assets/js/49.b989cb8f.js"><link rel="prefetch" href="/assets/js/5.9b395665.js"><link rel="prefetch" href="/assets/js/50.15af8405.js"><link rel="prefetch" href="/assets/js/51.edf352ef.js"><link rel="prefetch" href="/assets/js/52.3f1d14aa.js"><link rel="prefetch" href="/assets/js/53.63d16719.js"><link rel="prefetch" href="/assets/js/54.3de95c8f.js"><link rel="prefetch" href="/assets/js/55.440b64a4.js"><link rel="prefetch" href="/assets/js/56.b33a70aa.js"><link rel="prefetch" href="/assets/js/57.e710eecf.js"><link rel="prefetch" href="/assets/js/58.34d8338e.js"><link rel="prefetch" href="/assets/js/59.a4decd93.js"><link rel="prefetch" href="/assets/js/6.d5fd31a3.js"><link rel="prefetch" href="/assets/js/60.aa97eba7.js"><link rel="prefetch" href="/assets/js/61.a5c54723.js"><link rel="prefetch" href="/assets/js/62.98a91609.js"><link rel="prefetch" href="/assets/js/63.b523c85f.js"><link rel="prefetch" href="/assets/js/64.a9d9854e.js"><link rel="prefetch" href="/assets/js/65.247a1c65.js"><link rel="prefetch" href="/assets/js/66.86ef78b9.js"><link rel="prefetch" href="/assets/js/67.9fca9287.js"><link rel="prefetch" href="/assets/js/68.b4e9bc19.js"><link rel="prefetch" href="/assets/js/69.d6d04419.js"><link rel="prefetch" href="/assets/js/7.7cd0770b.js"><link rel="prefetch" href="/assets/js/70.d821cfe7.js"><link rel="prefetch" href="/assets/js/71.f88b33a3.js"><link rel="prefetch" href="/assets/js/72.61ea1e83.js"><link rel="prefetch" href="/assets/js/73.4c9a3e37.js"><link rel="prefetch" href="/assets/js/74.66313cc3.js"><link rel="prefetch" href="/assets/js/75.61024e27.js"><link rel="prefetch" href="/assets/js/76.f17fb6b7.js"><link rel="prefetch" href="/assets/js/77.bd651836.js"><link rel="prefetch" href="/assets/js/78.ac3ca5d4.js"><link rel="prefetch" href="/assets/js/79.5a92618c.js"><link rel="prefetch" href="/assets/js/8.2e118734.js"><link rel="prefetch" href="/assets/js/80.414890e8.js"><link rel="prefetch" href="/assets/js/81.00bfaa8c.js"><link rel="prefetch" href="/assets/js/82.80baaa77.js"><link rel="prefetch" href="/assets/js/83.e6b36923.js"><link rel="prefetch" href="/assets/js/84.5b32acfb.js"><link rel="prefetch" href="/assets/js/85.d79e7154.js"><link rel="prefetch" href="/assets/js/86.953d31b7.js"><link rel="prefetch" href="/assets/js/87.fdf14da0.js"><link rel="prefetch" href="/assets/js/88.0009f29c.js"><link rel="prefetch" href="/assets/js/89.bea5b9ea.js"><link rel="prefetch" href="/assets/js/9.43ae41b6.js"><link rel="prefetch" href="/assets/js/90.dcc0245d.js"><link rel="prefetch" href="/assets/js/91.e51769d3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9854472c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front/" class="nav-link">front</a></div><div class="nav-item"><a href="/houduan/" class="nav-link">back</a></div><div class="nav-item"><a href="/devOps/" class="nav-link router-link-active">devOps</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link">article</a></div><div class="nav-item"><a href="/northui/" class="nav-link">northui</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front/" class="nav-link">front</a></div><div class="nav-item"><a href="/houduan/" class="nav-link">back</a></div><div class="nav-item"><a href="/devOps/" class="nav-link router-link-active">devOps</a></div><div class="nav-item"><a href="/interview/" class="nav-link">interview</a></div><div class="nav-item"><a href="/article/" class="nav-link">article</a></div><div class="nav-item"><a href="/northui/" class="nav-link">northui</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">about</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>devOps</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/devOps/git.html" class="sidebar-link">git</a></li><li><a href="/devOps/nginx.html" class="sidebar-link">nginx</a></li><li><a href="/devOps/linux.html" class="sidebar-link">linux</a></li><li><a href="/devOps/docker.html" class="active sidebar-link">docker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devOps/docker.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#docker架构" class="sidebar-link">Docker架构</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#阿里云加速" class="sidebar-link">阿里云加速</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#image" class="sidebar-link">image</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#容器" class="sidebar-link">容器</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#制作镜像-使用" class="sidebar-link">制作镜像 &amp;&amp; 使用</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#数据盘" class="sidebar-link">数据盘</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#网络" class="sidebar-link">网络</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#compose" class="sidebar-link">compose</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#实战" class="sidebar-link">实战</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#dockerfile-制作nginx-nginx-静态目录" class="sidebar-link">Dockerfile 制作nginx =&gt; nginx 静态目录</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#私服" class="sidebar-link">私服</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#创建docker私服" class="sidebar-link">创建Docker私服</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#添加访问权限" class="sidebar-link">添加访问权限</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#登录制品库" class="sidebar-link">登录制品库</a></li><li class="sidebar-sub-header"><a href="/devOps/docker.html#邮箱配置" class="sidebar-link">邮箱配置</a></li></ul></li><li><a href="/devOps/jenkins.html" class="sidebar-link">jenkins</a></li><li><a href="/devOps/vscode.html" class="sidebar-link">vscode</a></li><li><a href="/devOps/jest.html" class="sidebar-link">jest base</a></li><li><a href="/devOps/k8s.html" class="sidebar-link">Kubernetes</a></li><li><a href="/devOps/cicd.html" class="sidebar-link">cicd</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="docker"><a href="#docker" aria-hidden="true" class="header-anchor">#</a> docker</h1> <blockquote><p>Docker 属于 Linux 容器的一种封装，提供简单易用的容器使用接口。它是目前最流行的 Linux 容器解决方案。Docker 将应用程序与该程序的依赖，打包在一个文件里面。运行这个文件，就会生成一个虚拟容器。程序在这个虚拟容器里运行，就好像在真实的物理机上运行一样</p></blockquote> <p></p><div class="table-of-contents"><ul><li><a href="#安装">安装</a></li><li><a href="#docker架构">Docker架构</a></li><li><a href="#阿里云加速">阿里云加速</a></li><li><a href="#image">image</a></li><li><a href="#容器">容器</a></li><li><a href="#制作镜像-使用">制作镜像 &amp;&amp; 使用</a><ul><li><a href="#制作dockerfile">制作Dockerfile</a></li><li><a href="#dockerfile编写例子-使用">Dockerfile编写例子 &amp;&amp; 使用</a></li></ul></li><li><a href="#数据盘">数据盘</a></li><li><a href="#网络">网络</a></li><li><a href="#compose">compose</a><ul><li><a href="#docker-compose-yml-使用">docker-compose.yml 使用</a></li></ul></li><li><a href="#实战">实战</a></li><li><a href="#dockerfile-制作nginx-nginx-静态目录">Dockerfile 制作nginx =&gt; nginx 静态目录</a></li><li><a href="#私服">私服</a><ul><li><a href="#配置-nexus">配置 Nexus</a></li></ul></li><li><a href="#创建docker私服">创建Docker私服</a></li><li><a href="#添加访问权限">添加访问权限</a></li><li><a href="#登录制品库">登录制品库</a><ul><li><a href="#推送镜像到制品库">推送镜像到制品库</a></li><li><a href="#拉取私有镜像">拉取私有镜像</a></li></ul></li><li><a href="#邮箱配置">邮箱配置</a></li></ul></div><p></p> <h2 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h2> <ul><li><a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener noreferrer">docker 连接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>docker 自带DNS功能  可以通过名字 互相访问</li> <li>所有的指令都是 docker 打头</li></ul> <div class="tip custom-block"><p class="custom-block-title">centos7.2中安装docker</p> <ul><li><p>yum -y install docker-io</p></li> <li><p>docker version</p></li> <li><p>docker info</p></li> <li><p>启动docker服务 systemctl start docker</p></li></ul></div> <h2 id="docker架构"><a href="#docker架构" aria-hidden="true" class="header-anchor">#</a> Docker架构</h2> <img src="/img/docker.jpg"> <h2 id="阿里云加速"><a href="#阿里云加速" aria-hidden="true" class="header-anchor">#</a> 阿里云加速</h2> <div class="language-js extra-class"><pre class="language-js"><code>mkdir <span class="token operator">-</span>p <span class="token operator">/</span>etc<span class="token operator">/</span>docker
tee <span class="token operator">/</span>etc<span class="token operator">/</span>docker<span class="token operator">/</span>daemon<span class="token punctuation">.</span>json <span class="token operator">&lt;&lt;</span><span class="token operator">-</span><span class="token string">'EOF'</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;registry-mirrors&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://fwvjnv59.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
<span class="token comment">// 重新加载某个服务的配置文件，如果新安装了一个服务，归属于 systemctl 管理，要是新服务的服务程序配置文件生效，需重新加载。</span>
systemctl daemon<span class="token operator">-</span>reload
<span class="token comment">// 重启docker服务</span>
systemctl restart docker
</code></pre></div><h2 id="image"><a href="#image" aria-hidden="true" class="header-anchor">#</a> image</h2> <blockquote><p>镜像  image 文件可以看作是容器的模板 一个 image 文件往往通过继承另一个 image 文件，加上一些个性化设置而生成  用来实例化的  可比喻一个类
上传大内容 比较快 原理:他会计算内容的hash值,保存起来,下来若有上传相同内容的文件,他会去计算内容hash,若有相同的 他会直接读入内部的数据,不会再次上传。docker image 上传也类似</p></blockquote> <ul><li>git 和 svn 原理
<ul><li>svn 每次变化,他会把文件生成一个快照 保存起来</li> <li>git 每次变化,仓库内存的只是相对上一次变化的内容 保存起来</li></ul></li> <li>基本操作</li> <li>镜像: 后面的默认是latest(默认最新,不是最新则要加版本号)</li></ul> <table><thead><tr><th>命令</th> <th>含义</th> <th>案例</th></tr></thead> <tbody><tr><td>images</td> <td>查看全部镜像</td> <td>docker image ls</td></tr> <tr><td>search</td> <td>查找镜像</td> <td>docker search [imageName]</td></tr> <tr><td>pull</td> <td>拉取镜像</td> <td>docker image pull [imageName]</td></tr> <tr><td>rmi</td> <td>删除镜像</td> <td>docker image rmi [imageName]</td></tr> <tr><td>inspect</td> <td>镜像信息</td> <td>docker image rmi [imageName]</td></tr> <tr><td>tag</td> <td>镜像取名字(会多一条记录)</td> <td>docker image tag [imageName] [myName]:latest(版本)</td></tr></tbody></table> <h2 id="容器"><a href="#容器" aria-hidden="true" class="header-anchor">#</a> 容器</h2> <blockquote><p>docker run 命令会从 image 文件，生成一个正在运行的容器实例 就像 new object 一样,当本地没有找到镜像,回去服务器拉取到本地,在创建容器</p></blockquote> <ul><li>docker container run hello-world 他会生成一个 容器,只打印一下日志就关闭(能启动后台服务的容器就不会关闭)</li> <li>后缀 添加 -a 显示所有容器</li> <li>后缀 -l 显示最新的容器</li></ul> <table><thead><tr><th>命令</th> <th>含义</th> <th>案例</th></tr></thead> <tbody><tr><td>run</td> <td>从镜像运行一个容器</td> <td>docker container run ubuntu /bin/echo 'hello-world'</td></tr> <tr><td>--rm</td> <td>运行完自动删除</td> <td>docker container run --rm ubuntu /bin/bash</td></tr> <tr><td>ps</td> <td>查看当前运行的容器</td> <td>docker container ps -a -l</td></tr> <tr><td>ls</td> <td>查看所有容器</td> <td>docker container ls -a</td></tr> <tr><td>inspect</td> <td>查看容器信息</td> <td>docker container inspect  [containerId]</td></tr> <tr><td>kill [containerId]</td> <td>终止容器(发送SIGKILL )</td> <td>docker kill [containerId]</td></tr> <tr><td>rm [containerId]</td> <td>删除容器</td> <td>docker rm [containerId]</td></tr> <tr><td>start [containerId]</td> <td>启动已经生成、已经停止运行的容器文件</td> <td>docker start [containerId]</td></tr> <tr><td>stop [containerId]</td> <td>终止容器运行 (发送 SIGTERM )</td> <td>docker stop [containerId]</td></tr> <tr><td>logs [containerId]</td> <td>查看 docker 容器的输出</td> <td>docker logs --follow [containerId]</td></tr> <tr><td>attach [containerId]</td> <td>进入容器</td> <td>docker attach [containerId]</td></tr> <tr><td>run [containerId]</td> <td>进入一个正在运行的 docker 容器</td> <td>docker container  run -it [container] /bin/bash(最后这个是执行的命令)</td></tr> <tr><td>exit</td> <td>docker 容器退出</td> <td>exit</td></tr> <tr><td>cp [containerId]</td> <td>从正在运行的 Docker 容器里面，将文件拷贝到本机</td> <td>docker container cp [containID]:app/package.json</td></tr></tbody></table> <h2 id="制作镜像-使用"><a href="#制作镜像-使用" aria-hidden="true" class="header-anchor">#</a> 制作镜像 &amp;&amp; 使用</h2> <div class="language-js extra-class"><pre class="language-js"><code>制作个性化镜像
    docker commit <span class="token operator">-</span>m<span class="token string">&quot;hello&quot;</span> <span class="token operator">-</span>a <span class="token string">&quot;sg&quot;</span> <span class="token punctuation">[</span>containerId<span class="token punctuation">]</span> sg<span class="token operator">/</span>hello<span class="token punctuation">:</span>latest
    docker images
    docker run sg<span class="token operator">/</span>hello <span class="token operator">/</span>bin<span class="token operator">/</span>bash
</code></pre></div><h3 id="制作dockerfile"><a href="#制作dockerfile" aria-hidden="true" class="header-anchor">#</a> 制作Dockerfile</h3> <blockquote><p>docker inspect centos</p></blockquote> <ul><li>Docker 的镜像是用一层一层的文件组成的</li> <li>docker inspect命令可以查看镜像或者容器</li> <li>Layers就是镜像的层文件，只读不能修改。基于镜像创建的容器会共享这些文件层</li> <li>.dockerignore(忽略文件)
<ul><li>.git</li> <li>node_modules</li></ul></li></ul> <div class="tip custom-block"><p class="custom-block-title">编写Dockerfile</p> <table><thead><tr><th>命令</th> <th style="text-align:left">含义</th> <th>案例</th></tr></thead> <tbody><tr><td>FROM</td> <td style="text-align:left">继承的镜像</td> <td>FROM node</td></tr> <tr><td>COPY</td> <td style="text-align:left">拷贝</td> <td>COPY ./app /app</td></tr> <tr><td>WORKDIR</td> <td style="text-align:left">指定工作路径</td> <td>WORKDIR /app</td></tr> <tr><td>RUN</td> <td style="text-align:left">编译打包阶段运行命令</td> <td>RUN npm install</td></tr> <tr><td>EXPOSE</td> <td style="text-align:left">暴露端口</td> <td>EXPOSE 3000</td></tr> <tr><td>CMD</td> <td style="text-align:left">容器运行阶段运行命令</td> <td>CMD npm run start</td></tr></tbody></table></div> <h3 id="dockerfile编写例子-使用"><a href="#dockerfile编写例子-使用" aria-hidden="true" class="header-anchor">#</a> Dockerfile编写例子 &amp;&amp; 使用</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code>1、node 安装
    wget <span class="token punctuation">-</span>qO<span class="token punctuation">-</span> https<span class="token punctuation">:</span>//raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh <span class="token punctuation">|</span> bash
    source ~/.bashrc
    nvm install stable
    node <span class="token punctuation">-</span>v
    npm i cnpm <span class="token punctuation">-</span>g
    npm i nrm <span class="token punctuation">-</span>g

    文件传输要安装 rz
    yum install lrzsz
 
    service nginx status //查看nginx开启状态
    service nginx start
    
    // 使用lsof
    yum install lsof
    lsof <span class="token punctuation">-</span>i<span class="token punctuation">:</span>8080 //查看8080端口
  
    // 杀进程
    kill <span class="token punctuation">-</span>s 9 进程号

    // 开启服务 后台运行
    node serve.js &amp;

    // 安装 git
    yum install <span class="token punctuation">-</span>y git
    // 创建git用户
    useradd git
    passwd git
2、安装express
    npm install express<span class="token punctuation">-</span>generator <span class="token punctuation">-</span>g
    express app

3、Dockerfile
    vim Dockerfile
    写入 
        FROM node
        COPY ./app /app
        WORKDIR /app
        RUN npm install
        EXPOSE 3000
4、运行 docker build <span class="token punctuation">-</span>t express<span class="token punctuation">-</span>demo .
<span class="token punctuation">-</span>t用来指定image镜像的名称，后面还可以加冒号指定标签，如果不指定默认就是latest
.表示Dockerfile文件的所有路径<span class="token punctuation">,</span>.就表示当前路径

5、使用
<span class="token punctuation">-</span> <span class="token punctuation">-</span>p 端口映射(容器内的端口映射到主机<span class="token punctuation">,</span>p是publish<span class="token punctuation">-</span>port缩写)
docker container run <span class="token punctuation">-</span>p 3333<span class="token punctuation">:</span>3000 <span class="token punctuation">-</span>it express<span class="token punctuation">-</span>demo /bin/bash
<span class="token punctuation">-</span> 让 容器 的nginx 80端口 映射主机的8080端口<span class="token punctuation">,</span>有人访问了主机的8080端口 他会映射到容器的80端口
docker run <span class="token punctuation">-</span>p 8080<span class="token punctuation">:</span>80 nginx
<span class="token punctuation">-</span> <span class="token punctuation">-</span>d 后台运行
docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span>p 8080<span class="token punctuation">:</span>80 nginx
<span class="token punctuation">-</span> top 查看进程 containerId只需要输入部分
docker container top <span class="token punctuation">[</span>containerId<span class="token punctuation">]</span>
<span class="token punctuation">-</span> 一般一个服务对应一个docker 容器

6、发布
docker login
docker image tag <span class="token punctuation">[</span>north_uc_1<span class="token punctuation">]</span> <span class="token punctuation">[</span>username<span class="token punctuation">]</span>/<span class="token punctuation">[</span>repository<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">[</span>tag<span class="token punctuation">]</span>
docker image build <span class="token punctuation">-</span>t <span class="token punctuation">[</span>username<span class="token punctuation">]</span>/<span class="token punctuation">[</span>repository<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">[</span>tag<span class="token punctuation">]</span> .
<span class="token comment"># songge songge  账号密码 https://hub.docker.com</span>
docker tag express<span class="token punctuation">-</span>demo songge/express<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>1.0.0
docker push songge/express<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>1.0.0
</code></pre></div><ul><li>3注释
<ul><li>FROM 表示该镜像继承的镜像 :表示标签</li> <li>COPY 是将当前目录下的app目录下面的文件都拷贝到image里的/app目录中</li> <li>WORKDIR 指定工作路径，类似于执行 cd 命令</li> <li>RUN npm install 在/app目录下安装依赖，安装后的依赖也会打包到image目录中</li> <li>EXPOSE 暴露3000端口，允许外部连接这个端口</li></ul></li> <li>4注释
<ul><li>-p 参数是将容器的3000端口映射为本机的3333端口,通过访问本机的3333端口就可以 访问到容器的3000</li> <li>-it 参数是将容器的shell容器映射为当前的shell,在本机容器中执行的命令都会发送到容器当中执行express-demo image的名称</li> <li>/bin/bash 容器启动后执行的第一个命令,这里是启动了bash容器以便执行脚本</li> <li>--rm 在容器终止运行后自动删除容器文件</li></ul></li></ul> <h2 id="数据盘"><a href="#数据盘" aria-hidden="true" class="header-anchor">#</a> 数据盘</h2> <ul><li><p>删除容器的时候，容器层里创建的文件也会被删除掉，如果有些数据你想永久保存，比如Web服务器的日志，数据库管理系统中的数据，可以为容器创建一个数据盘。</p></li> <li><p>创建容器的时候我们可以通过-v或--volumn给它指定一下数据盘</p></li> <li><p>指定数据盘</p> <ul><li>~/data:/mnt 把当前用户目录中的data目录映射到/mnt上</li> <li>: 前是linux内的空间  后是容器内的空间</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>mkdir <span class="token operator">~</span><span class="token operator">/</span>data
docker run <span class="token operator">-</span>v <span class="token operator">~</span><span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>mnt <span class="token operator">-</span>ti <span class="token operator">--</span>name logs2 centos bash
cd <span class="token operator">/</span>mnt
echo <span class="token number">3</span> <span class="token operator">&gt;</span> <span class="token number">3.</span>txt
exit
cat <span class="token operator">~</span><span class="token operator">/</span>data<span class="token operator">/</span><span class="token number">3.</span>txt
</code></pre></div><ul><li>容器共享数据盘</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>docker create <span class="token operator">-</span>v <span class="token operator">/</span>mnt <span class="token operator">--</span>name logger <span class="token function">centos</span> <span class="token punctuation">(</span>在linux中创建数据盘<span class="token punctuation">,</span><span class="token parameter">name</span><span class="token operator">=&gt;</span>logger<span class="token punctuation">)</span>
docker run <span class="token operator">--</span>volumes<span class="token operator">-</span><span class="token keyword">from</span> logger <span class="token operator">--</span>name logger3 <span class="token operator">-</span>i <span class="token operator">-</span>t centos <span class="token function">bash</span><span class="token punctuation">(</span>初始化容器指定logger容器<span class="token punctuation">)</span>
cd <span class="token operator">/</span>mnt 
touch logger3
docker run <span class="token operator">--</span>volumes<span class="token operator">-</span><span class="token keyword">from</span> logger <span class="token operator">--</span>name logger4 <span class="token operator">-</span>i <span class="token operator">-</span>t centos bash
cd <span class="token operator">/</span>mnt
touch logger4
</code></pre></div><ul><li>管理数据盘</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>docker volume ls 列出所有的数据盘
docker volume ls <span class="token operator">-</span>f dangling<span class="token operator">=</span><span class="token boolean">true</span> 列出已经孤立的数据盘
docker volume rm xxxx
docker volume ls
docker rm logger1 logger2
docker volume inspect xxx
docker rm logger <span class="token operator">-</span>v
</code></pre></div><h2 id="网络"><a href="#网络" aria-hidden="true" class="header-anchor">#</a> 网络</h2> <ul><li>docker里面有一个DNS服务，可以通过容器名称访问主机 网络类型</li></ul> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>none 无网络，对外界完全隔离</p> <p>host 主机网络</p> <p>bridge 桥接网络，默认网络</p></div> <ul><li>bridge</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>docker network ls
docker inspect bridge
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name server1 nginx
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name server2 nginx
docker exec <span class="token operator">-</span>it server1 bash
ping server2
</code></pre></div><ul><li>none</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>docker run <span class="token operator">-</span>d <span class="token operator">--</span>name server_none <span class="token operator">--</span>net none nginx
docker inspect none
docker exec <span class="token operator">-</span>it server_none bash
ip addr
</code></pre></div><ul><li>host</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>docker run <span class="token operator">-</span>d <span class="token operator">--</span>name server_host <span class="token operator">--</span>net host nginx
docker inspect none
docker exec <span class="token operator">-</span>it server_host bash
ip addr
</code></pre></div><ul><li>访问桥接网络里面的服务
<ul><li>访问主机的8080端口会被定向到容器的80端口</li></ul></li></ul> <div class="language- extra-class"><pre class="language-text"><code>docker inspect nginx
docker run -d --name server_nginx -p &quot;8080:80&quot;  nginx
</code></pre></div><ul><li>查看主机绑定的端口</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>docker inspect <span class="token punctuation">[</span>容器名称<span class="token punctuation">]</span>
docker port server_nginx
</code></pre></div><h2 id="compose"><a href="#compose" aria-hidden="true" class="header-anchor">#</a> compose</h2> <div class="language-js extra-class"><pre class="language-js"><code> 安装 pip install docker<span class="token operator">-</span>compose
</code></pre></div><ul><li>Compose 通过一个配置文件来管理多个Docker容器，在配置文件中，所有的容器通过services来定义，然后使用docker-compose脚本来启动，停止和重启应用，和应用中的服务以及所有依赖服务的容器，非常适合组合使用多个容器进行开发的场景 步骤：</li> <li>在 docker-compose.yml 中定义组成应用程序的服务，以便它们可以在隔离的环境中一起运行。</li> <li>最后，运行docker-compose up，Compose 将启动并运行整个应用程序。 配置文件组成</li> <li>services 可以定义需要的服务，每个服务都有自己的名字、使用的镜像、挂载的数据卷所属的网络和依赖的其它服务。</li> <li>networks 是应用的网络，在它下面可以定义使用的网络名称，类性。</li> <li>volumes是数据卷，可以在此定义数据卷，然后挂载到不同的服务上面使用。</li></ul> <h3 id="docker-compose-yml-使用"><a href="#docker-compose-yml-使用" aria-hidden="true" class="header-anchor">#</a> docker-compose.yml 使用</h3> <ul><li>空格缩进表示层次</li> <li>冒号空格后面有空格</li></ul> <div class="language- extra-class"><pre class="language-text"><code>version: '2'
services:
  zfpx1:
    image: nginx
    port:
      - &quot;8080:80&quot;
  zfpx2:
    image: nginx
    port:
      - &quot;8081:80&quot;
</code></pre></div><ul><li>nginx工具包</li></ul> <blockquote><p>docker体积很小</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>apt update
#ping
apt install inetutils<span class="token operator">-</span>ping 
#nslookup
apt install dnsutils   
#ifconfig 
apt install net<span class="token operator">-</span>tools    
#ip
apt install iproute2     
#curl
apt install curl
</code></pre></div><ul><li>启动</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>docker<span class="token operator">-</span>compose up 启动所有的服务
docker<span class="token operator">-</span>compose <span class="token operator">-</span>d 后台启动所有的服务
docker<span class="token operator">-</span>compose ps 打印所有的容器
docker<span class="token operator">-</span>compose stop 停止所有服务
docker<span class="token operator">-</span>compose logs <span class="token operator">-</span>f 持续跟踪日志
docker<span class="token operator">-</span>compose exec zfpx1 bash 进入zfpx服务系统
docker<span class="token operator">-</span>compose rm 删除服务容器
docker network ls 网络不会删除
docker<span class="token operator">-</span>compose down 删除网路
</code></pre></div><h2 id="实战"><a href="#实战" aria-hidden="true" class="header-anchor">#</a> 实战</h2> <ul><li>nodeapp 是一个用 Docker 搭建的本地 Node.js 应用开发与运行环境。</li></ul> <div class="tip custom-block"><p class="custom-block-title">服务</p> <p>node：启动node服务</p> <p>web：使用 nginx 作为应用的 web 服务器</p></div> <div class="tip custom-block"><p class="custom-block-title">结构</p> <ul><li><p>app：这个目录存储应用</p> <ul><li>web 放应用的代码</li></ul></li> <li><p>services： 环境里定义的服务需要的一些服务</p></li> <li><p>images: 方式一些贬义的脚本和镜像</p></li> <li><p>docker-compose.yml：定义本地开发环境需要的服务</p></li> <li><p>images/nginx/config/default.conf 放置nginx 配置文件</p></li> <li><p>node 的Dockfile配置文件</p></li></ul></div> <ul><li>docker-compose.yml</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>version<span class="token punctuation">:</span> <span class="token string">'2'</span>
services<span class="token punctuation">:</span>
 node<span class="token punctuation">:</span>
  build<span class="token punctuation">:</span>
    context<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>images<span class="token operator">/</span>node
    dockerfile<span class="token punctuation">:</span> Dockerfile
  volumes<span class="token punctuation">:</span>
    <span class="token operator">-</span> <span class="token punctuation">.</span><span class="token operator">/</span>app<span class="token operator">/</span>web<span class="token punctuation">:</span><span class="token operator">/</span>web
  depends_on<span class="token punctuation">:</span>
   <span class="token operator">-</span> db
 web<span class="token punctuation">:</span>
  image<span class="token punctuation">:</span> nginx
  ports<span class="token punctuation">:</span>
   <span class="token operator">-</span> <span class="token string">&quot;8080:80&quot;</span>
  volumes<span class="token punctuation">:</span>
   <span class="token operator">-</span> <span class="token punctuation">.</span><span class="token operator">/</span>images<span class="token operator">/</span>nginx<span class="token operator">/</span>config<span class="token punctuation">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d
   <span class="token operator">-</span> <span class="token punctuation">.</span><span class="token operator">/</span>app<span class="token operator">/</span>web<span class="token operator">/</span>views<span class="token punctuation">:</span><span class="token operator">/</span>mnt<span class="token operator">/</span>views  
  depends_on<span class="token punctuation">:</span>
   <span class="token operator">-</span> node
 db<span class="token punctuation">:</span>
  image<span class="token punctuation">:</span> mariadb
  environment<span class="token punctuation">:</span>
   <span class="token constant">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">&quot;root&quot;</span>
   <span class="token constant">MYSQL_DATABASE</span><span class="token punctuation">:</span> <span class="token string">&quot;node&quot;</span>
   <span class="token constant">MYSQL_USER</span><span class="token punctuation">:</span> <span class="token string">&quot;zfpx&quot;</span>
   <span class="token constant">MYSQL_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>
  volumes<span class="token punctuation">:</span>
    <span class="token operator">-</span> db<span class="token punctuation">:</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql
volumes<span class="token punctuation">:</span>
 db<span class="token punctuation">:</span>
  driver<span class="token punctuation">:</span> local
</code></pre></div><ul><li>app/web/server.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> http<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> mysql  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host     <span class="token punctuation">:</span> <span class="token string">'db'</span><span class="token punctuation">,</span>
  user     <span class="token punctuation">:</span> <span class="token string">'zfpx'</span><span class="token punctuation">,</span>
  password <span class="token punctuation">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
  database <span class="token punctuation">:</span> <span class="token string">'node'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span>http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 2 + 2 AS solution'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token operator">+</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>solution<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>package.json</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;start&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;node server.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>images/node/Dockerfile</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">FROM</span> node
<span class="token constant">MAINTAINER</span> zhangrenyang <span class="token operator">&lt;</span>zhang_renyang@<span class="token number">126.</span>com<span class="token operator">&gt;</span>
<span class="token constant">WORKDIR</span> <span class="token operator">/</span>web
<span class="token constant">RUN</span> npm install
<span class="token constant">CMD</span> npm start
</code></pre></div><ul><li>images/nginx/config/default.conf</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>upstream backend <span class="token punctuation">{</span>
    server node<span class="token punctuation">:</span><span class="token number">3000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name localhost<span class="token punctuation">;</span>
    root <span class="token operator">/</span>mnt<span class="token operator">/</span>views<span class="token punctuation">;</span>
    index index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>

    location <span class="token operator">/</span>api <span class="token punctuation">{</span>
        proxy_pass http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>backend<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="dockerfile-制作nginx-nginx-静态目录"><a href="#dockerfile-制作nginx-nginx-静态目录" aria-hidden="true" class="header-anchor">#</a> Dockerfile 制作nginx =&gt; nginx 静态目录</h2> <ul><li>mkdir conf/nginx.conf</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment">#user  nobody;</span>

events <span class="token punctuation">{</span>
    worker_connections  1024;
    use epoll;
<span class="token punctuation">}</span>
http <span class="token punctuation">{</span>
    include mime.types;
    default_type  application/octet<span class="token punctuation">-</span>stream;
    server <span class="token punctuation">{</span>
        listen 80;
        server_name  _;
        root /etc/nginx/html/;
        location / <span class="token punctuation">{</span>
            try_files $uri /index.html;
            root /etc/nginx/html/;
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Dockerfile
<ul><li>利用<code>conf/nginx.conf</code> 替换<code>nginx</code>里面的<code>/etc/nginx/</code>的核心文件</li></ul></li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code>FROM nginx<span class="token punctuation">:</span>1.15<span class="token punctuation">-</span>alpine
COPY build /etc/nginx/html
COPY conf /etc/nginx/
WORKDIR /etc/nginx/html
</code></pre></div><ul><li>mkdir <code>build/index.html</code></li></ul> <div class="language-html extra-class"><pre class="language-html"><code>test1
</code></pre></div><ul><li>tag</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code>docker tag express<span class="token punctuation">-</span>demo songge/express<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>1.0.0
docker push songge/express<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>1.0.0 
</code></pre></div><h2 id="私服"><a href="#私服" aria-hidden="true" class="header-anchor">#</a> 私服</h2> <ul><li>部署 Nexus 服务</li> <li>nexus-3.29.0-02 是nexus主程序文件夹</li> <li>sonatype-work 则是数据文件</li> <li>nexus 还支持停止，重启等命令。可以在 bin 目录下执行 ./nexus help 查看更多命令</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code>cd /usr/local
wget https<span class="token punctuation">:</span>//dependency<span class="token punctuation">-</span>fe.oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>beijing.aliyuncs.com/nexus<span class="token punctuation">-</span>3.29.0<span class="token punctuation">-</span>02<span class="token punctuation">-</span>unix.tar.gz
tar <span class="token punctuation">-</span>zxvf ./nexus<span class="token punctuation">-</span>3.29.0<span class="token punctuation">-</span>02<span class="token punctuation">-</span>unix.tar.gz
cd nexus<span class="token punctuation">-</span>3.29.0<span class="token punctuation">-</span>02/bin
./nexus start

firewall<span class="token punctuation">-</span>cmd <span class="token punctuation">-</span><span class="token punctuation">-</span>zone=public <span class="token punctuation">-</span><span class="token punctuation">-</span>add<span class="token punctuation">-</span>port=8081/tcp <span class="token punctuation">-</span><span class="token punctuation">-</span>permanent
firewall<span class="token punctuation">-</span>cmd <span class="token punctuation">-</span><span class="token punctuation">-</span>zone=public <span class="token punctuation">-</span><span class="token punctuation">-</span>add<span class="token punctuation">-</span>port=8082/tcp <span class="token punctuation">-</span><span class="token punctuation">-</span>permanent

http<span class="token punctuation">:</span>//8.144.177.239<span class="token punctuation">:</span>8081/
</code></pre></div><h3 id="配置-nexus"><a href="#配置-nexus" aria-hidden="true" class="header-anchor">#</a> 配置 Nexus</h3> <ul><li>可以使用admin用户登录Nexus</li> <li>注意请立即更改密码</li> <li>Enable anonymous access</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code>cat /root/sonatype<span class="token punctuation">-</span>work/nexus3/admin.password 
</code></pre></div><h2 id="创建docker私服"><a href="#创建docker私服" aria-hidden="true" class="header-anchor">#</a> 创建Docker私服</h2> <ul><li>密码:Sg920322</li> <li>登录 =&gt; 齿轮图标 =&gt; Repositories =&gt; Create repository =&gt; docker(hosted) =&gt; HTTP(8082)
<ul><li>8082 修改仓库的port 默认是8081</li></ul></li> <li>proxy: 此类型制品库原则上只下载，不允许用户推送</li> <li>hosted：此类型制品库和 proxy 相反，原则上 只允许用户推送，不允许缓存。这里只存放自己的私有镜像或制品</li> <li>group：此类型制品库可以将以上两种类型的制品库组合起来</li></ul> <h2 id="添加访问权限"><a href="#添加访问权限" aria-hidden="true" class="header-anchor">#</a> 添加访问权限</h2> <ul><li>齿轮图标 =&gt; Realms =&gt; Docker Bearer Token Realm =&gt; 添加到右边的 Active =&gt;保存</li> <li>copy http://118.190.142.109:8081/repository/dockcer-repository/</li></ul> <h2 id="登录制品库"><a href="#登录制品库" aria-hidden="true" class="header-anchor">#</a> 登录制品库</h2> <ul><li>默认情况下不能识别http协议的  他认为不安全 需要加下面配置 ip是仓库地址</li> <li>vi /etc/docker/daemon.json</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">{</span>
  <span class="token comment"># 通过https 请求</span>
  <span class="token key atrule">&quot;insecure-registries&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;8.144.177.239:8082&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token key atrule">&quot;registry-mirrors&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://fwvjnv59.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

systemctl restart docker <span class="token comment"># 记得要重启</span>
docker login 8.142.41.191<span class="token punctuation">:</span>8082 //注意此处要和insecure<span class="token punctuation">-</span>registries里的地址一致
<span class="token key atrule">Username</span><span class="token punctuation">:</span> admin
<span class="token key atrule">Password</span><span class="token punctuation">:</span> Sg920322
</code></pre></div><h3 id="推送镜像到制品库"><a href="#推送镜像到制品库" aria-hidden="true" class="header-anchor">#</a> 推送镜像到制品库</h3> <ul><li>设置界面 =&gt; 构建环境 =&gt; 勾选 Use secret text(s) or file(s) =&gt; 新增选择 =&gt; Username and password (separated)</li> <li>DOCKER_LOGIN_USERNAME</li> <li>DOCKER_LOGIN_PASSWORD</li> <li>接着在下面指定凭据=&gt;添加jenkins=&gt;选择类型Username with password,输入用户名和密码然后点添加确定</li> <li>打包的时候 一定要吧ip:port携带上  例如：<code>8.142.41.191:8082/xxx</code>,如果不带 push不了</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment">#!/bin/sh -l</span>

npm install <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=https<span class="token punctuation">:</span>//registry.npm.taobao.org
npm run build
time=$(date &quot;+%Y%m%d%H%M%S&quot;)DOCKER_LOGIN_PASSWORD
<span class="token comment"># 在nexus 上会分层显示</span>
<span class="token comment"># 8.142.41.191:8082 ip</span>
<span class="token comment"># cicd-backend 镜像名字</span>
<span class="token comment"># target $time </span>
docker build <span class="token punctuation">-</span>t 8.142.41.191<span class="token punctuation">:</span>8082/cicd<span class="token punctuation">-</span>backend<span class="token punctuation">:</span>$time .
docker login <span class="token punctuation">-</span>u $DOCKER_LOGIN_USERNAME <span class="token punctuation">-</span>p $DOCKER_LOGIN_PASSWORD 8.142.41.191<span class="token punctuation">:</span><span class="token number">8082</span>
docker push 8.142.41.191<span class="token punctuation">:</span>8082/cicd<span class="token punctuation">-</span>backend<span class="token punctuation">:</span>$time
</code></pre></div><ul><li>然后就可以查看镜像了,注意端口是8081</li></ul> <h3 id="拉取私有镜像"><a href="#拉取私有镜像" aria-hidden="true" class="header-anchor">#</a> 拉取私有镜像</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code>docker pull 8.144.177.239<span class="token punctuation">:</span>8082/test4
</code></pre></div><h2 id="邮箱配置"><a href="#邮箱配置" aria-hidden="true" class="header-anchor">#</a> 邮箱配置</h2> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">mail.host</span><span class="token punctuation">:</span> <span class="token string">'smtp.qq.com'</span>
<span class="token key atrule">mail.port</span><span class="token punctuation">:</span> <span class="token number">465</span>
<span class="token key atrule">mail.username</span><span class="token punctuation">:</span> <span class="token string">'501798525@qq.com'</span>
<span class="token key atrule">mail.password</span><span class="token punctuation">:</span> <span class="token string">'alukbihtftrpbjcb'</span>
<span class="token key atrule">mail.use-tls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">mail.use-ssl</span><span class="token punctuation">:</span> <span class="token boolean important">True</span>
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2/18/2022, 2:02:46 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/devOps/linux.html" class="prev">
          linux
        </a></span> <span class="next"><a href="/devOps/jenkins.html">
          jenkins
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.188d2b4b.js" defer></script><script src="/assets/js/45.3b76131f.js" defer></script>
  </body>
</html>
